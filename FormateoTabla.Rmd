<center><img src="https://github.com/PoliticayGobiernoPUCP/estadistica_anapol2/raw/master/PICS/LOGO_PUCP.png" width="500"></center>

<center> <header><h1>ESTADISTICA PARA EL ANALISIS POLITICO II</h1>  </header></center>

* Profesor:  <a href="http://www.pucp.edu.pe/profesor/jose-manuel-magallanes/" target="_blank">Dr. José Manuel Magallanes, Ph.D.</a> <br>
    - Profesor del Departamento de Ciencias Sociales, Sección de Ciencia Política y Gobierno.
    - [Oficina 105](https://goo.gl/maps/xuGeG6o9di1i1y5m6) - Edificio CISEPA / ECONOMIA / CCSS
    - Telefono: (51) 1 - 6262000 anexo 4302
    - Correo Electrónico: [jmagallanes@pucp.edu.pe](mailto:jmagallanes@pucp.edu.pe)
    

____

<center> <header><h2>Preparación de Tabla de Datos</h2>  </header></center>
____

<a id='beginning'></a>

____

**Data 1: PBI per cápita** 

Cargamos datos: 

```{r}
library(htmltab) #activando (debe estar instalado)

url1 = "https://www.cia.gov/library/publications/resources/the-world-factbook/fields/211rank.html" 
gdp = htmltab(doc = url1, 
               which ='//*[@id="rankOrder"]',
               encoding = "UTF-8") 
```

Verificando estructura:
```{r}
str(gdp)
```


Notamos que la terceca y la cuarta columna tienen informacion numerica y de texto. Antes de hacer cambiamos, pongamosle nombres simples:


```{r}
names(gdp)[c(3,4)]=c('pbi','estimado')
```

Resolvamos la que tiene numeros como moneda ('currency'). Como sólo es un valor, podemos usar la función *parse_number* de la bilioteca **readr** (verificar si la tienes)>

```{r}
library(readr)

parse_number('US$ 23,998.56') # solo recupera primer numero
```

De ahí que:
```{r}
gdp$pbi=parse_number(gdp$pbi)
```

Para el segundo caso, podemos usar:
```{r}
library(stringr)
library(magrittr)  # para el %>%
str_extract_all(gdp$estimado,pattern="\\d+",simplify = T)[,1]%>%as.numeric()
```

O...

```{r}
parse_number(gdp$estimado) # ya está convertido en numero.
```


**¿Sobra o falta algo?**

Filas sin sentido, filas o columnas vacias, filas resumen, nombres de columna muy largos, etc.

Últimos casos: 

```{r}
tail(gdp) #no hay filas por eliminar
```

Primeros casos:

```{r}
head(gdp)#no hay filas por eliminar
```

Nombres de Variables: 
```{r}
names(gdp)
```


Selecciono variables de trabajo:

```{r}
gdp = gdp[,c(2,3)]  #columnas 2 y 3
```

Cambiamos nombre de las variables: 
```{r}
names(gdp) = c("Pais", "PBI")
```

Revisemos estructura de datos:

```{r}
str(gdp)
```

```{r}
summary(gdp) #estadisticos?
```

Eliminemos simbolos de moneda y comas de la variable PBI:

```{r}
gdp$PBI =   gsub("\\$|\\,", "", gdp$PBI) #| es "o" 


gdp$PBI #Resultado
```

Convertimos variable a numérica:

```{r}
gdp$PBI = as.numeric(gdp$PBI)

summary(gdp) #verificamos
```


**Data 2: Urbanización** 

Cargamos datos: 

```{r}
url2 = "https://www.cia.gov/library/publications/resources/the-world-factbook/fields/349.html"

urban = htmltab(doc = url2, 
                which ='//*[@id="fieldListing"]',
                encoding = "UTF-8")

```
```{r}
head(urban)
```

Revisemos estructura de datos:

```{r}
str(urban)
```

Veamos unas celdas:

```{r}
urban$Urbanization[1:3]
```

Lo anterior nos permite  encontrar un patrón que nos permita seleccionar los datos de interés. 

```{r}
library(tidyr)
urban=separate(urban,Urbanization,
               into=c("Urbano"), 
               "% of total population")
```

```{r}
head(urban)
```
```{r}
library(stringr)

str_extract(urban$Urbano, "\\d+\\.*\\d*")
```

```{r}
urban$Urbano=as.numeric(
        str_extract(urban$Urbano, "\\d+\\.*\\d*")
        )
```



```{r}
summary(urban)
```
```{r}
names(urban)[1]
```

```{r}
names(urban)[1]="Pais"
names(urban)
```


**Data 3: Emisión de CO2** 

Cargamos datos: 

```{r}
url3 = "https://www.cia.gov/library/publications/resources/the-world-factbook/fields/274.html"
cdio<- htmltab(doc = url3, 
                  which ='//*[@id="fieldListing"]',encoding = "UTF-8")

```

```{r}
head(cdio)
```



Cambiamos nombre de las variables: 
```{r}
names(cdio) = c("Pais", "co2")
```

```{r}
separate(cdio,co2,
         into=c("co2"), 
         "\\(")
```

```{r}
cdio=separate(cdio,co2,into=c("co2"), "\\(")
```

```{r}
separate(cdio,co2,
         into=c("co2",'multiplo','unidad'),
         " ")
```

```{r}
cdio=separate(cdio,co2,into=c("co2",'multiplo','unidad'), " ")
```

```{r}
table(cdio$multiplo,useNA ='always')
```

```{r}
table(cdio$unidad,useNA ='always')
```

No necesitamos unidad, pues no hay referencia a million ni billion
```{r}
cdio$unidad=NULL
```


Donde haya billion o million o Mt ponemos el factor multiplicador 
```{r}
library(dplyr)
recode(cdio$multiplo,billion=10^9,million=10^6,Mt=1)
```
```{r}
cdio$multiplo=recode(cdio$multiplo,billion=10^9,million=10^6,Mt=1)
```

```{r}
cdio$co2
```

```{r}
cdio$co2 =gsub(",", "", cdio$co2) #Eliminar caracteres especiales
cdio$co2=as.numeric(cdio$co2)
summary(cdio)
```

```{r}
cdio$co2=(cdio$co2*cdio$multiplo)/(10^6) #base million
```

```{r}
summary(cdio)
```


```{r}
cdio$multiplo=NULL
```


```{r}
merge_urban=merge(urban,gdp,all.x=T,all.y=T)
head(merge_urban)
```


```{r}
merge_urban[!complete.cases(merge_urban),]
```

```{r}
cia=merge(merge_urban,cdio,all.x=T,all.y=T)
head(cia)
```


```{r}
cia[!complete.cases(cia),]
```

```{r}
cia[grep("World|Euro",cia$Pais),]
```

```{r}
cia=cia[-grep("World|Euro",cia$Pais),]
```




**Data 4: DEMOCRACY INDEX** 

Cargamos datos: 

```{r}
library(htmltab)
url4 = "https://en.wikipedia.org/wiki/Democracy_Index"
demo<- htmltab(doc = url4, 
                  which ='//*[@id="mw-content-text"]/div/table[2]/tbody',encoding = "UTF-8")

```

```{r}
head(demo)
```

```{r}
tail(demo)
```

Nombre inadecuados. Guardando los actuales:

```{r}
oldNames=as.data.frame(names(demo))
oldNames
```
```{r}
as.vector(unlist(separate(oldNames,'names(demo)','newNames',sep=" ")))
```

```{r}
names(demo)=as.vector(unlist(separate(oldNames,'names(demo)','newNames',sep=" ")))
head(demo)
```
```{r}
str(demo)
```


```{r}
# sale lo que quiero?
lapply(demo[,c(3:8)],as.numeric)
```


```{r}

# lo ejecuto:
demo[,c(3:8)]=lapply(demo[,c(3:8)],as.numeric)
```

```{r}
# que valores tengo?
table(demo$Regimetype,exclude = 'nothing')
```

```{r}
#sale lo que quiero?

recode(demo$Regimetype,
       'Full democracy'='4FullDemocracy',
       'Flawed democracy'='3FlawedDemocracy',
       'Hybrid regime'='2Hybrid regime',
       'Authoritarian'='1Authoritarian')
```
```{r}
demo$Regimetype= recode(demo$Regimetype,
       'Full democracy'='4FullDemocracy',
       'Flawed democracy'='3FlawedDemocracy',
       'Hybrid regime'='2Hybrid regime',
       'Authoritarian'='1Authoritarian')
```

```{r}
# poner numero delante, ayuda a crear una ordinal
demo$Regimetype=as.ordered(demo$Regimetype)
```

```{r}
demo$Regimetype
```

No quero esto:
```{r}
demo$Rank=NULL
demo$Score=NULL
```

```{r}
str(demo)
```


```{r}
str(cia)
```


```{r}
# merge no detallado, solo queda lo que coincida en ambas:
merge(cia,demo,by.x = 'Pais',by.y = 'Country')
```
```{r}
# esto deberi limpiar:
trimws(demo$Country)
```

Debes ir al help, y te recomienda:
```{r}

trimws(demo$Country,whitespace = "[\\h\\v]")
```

Lo usas:
```{r}
demo$Country=trimws(demo$Country,whitespace = "[\\h\\v]")
```

Y procedes con el merge:
```{r}
merge(cia,demo,by.x = 'Pais',by.y = 'Country')
```

```{r}
ciademo=merge(cia,demo,by.x = 'Pais',by.y = 'Country')
```

_____
<br></br>

[al INICIO](#beginning)

[VOLVER A CONTENIDOS](https://politicaygobiernopucp.github.io/estadistica_anapol2/)